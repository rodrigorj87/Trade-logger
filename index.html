<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinkorSwim Trade Logger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    <div id="app" class="p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">ThinkorSwim Trade Logger</h1>
                        <p class="text-slate-400">Import and analyze your trading history</p>
                    </div>
                    <button id="clearData" class="hidden px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors text-sm font-medium">
                        Clear All Data
                    </button>
                </div>
                <div id="savedIndicator" class="hidden mt-3 text-sm text-green-400 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Data saved online - accessible from any device
                </div>
            </div>

            <!-- Upload Section -->
            <div class="bg-slate-800/50 backdrop-blur rounded-xl p-8 mb-6 border border-slate-700">
                <label for="csvFile" class="flex flex-col items-center justify-center cursor-pointer hover:bg-slate-700/30 transition-colors rounded-lg p-8 border-2 border-dashed border-slate-600">
                    <svg class="w-12 h-12 text-blue-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span class="text-lg text-white mb-2">Upload ThinkorSwim CSV</span>
                    <span class="text-sm text-slate-400">Click to browse or drag and drop</span>
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                </label>
                <div class="mt-4 flex items-center justify-center">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="appendMode" class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-slate-300">Append to existing trades (don't replace)</span>
                    </label>
                </div>
            </div>

            <!-- Statistics -->
            <div id="stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-blue-100">Total P&L</span>
                        <svg class="w-5 h-5 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div id="totalPnl" class="text-3xl font-bold text-white">$0.00</div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400">Win Rate</span>
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div id="winRate" class="text-3xl font-bold text-white">0%</div>
                    <div id="winLoss" class="text-sm text-slate-400 mt-1">0W / 0L</div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400">Avg Win</span>
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div id="avgWin" class="text-3xl font-bold text-green-400">$0.00</div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400">Avg Loss</span>
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                        </svg>
                    </div>
                    <div id="avgLoss" class="text-3xl font-bold text-red-400">$0.00</div>
                </div>
            </div>

            <!-- Search -->
            <div id="searchBox" class="hidden mb-6">
                <div class="relative">
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search by symbol..." class="w-full bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl pl-12 pr-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition-colors">
                </div>
            </div>

            <!-- Trades Table -->
            <div id="tradesTable" class="hidden bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-slate-900/50">
                                <th class="px-6 py-4 text-left text-sm font-semibold text-slate-300">Date</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-slate-300">Symbol</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-slate-300">Type</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-slate-300">Side</th>
                                <th class="px-6 py-4 text-right text-sm font-semibold text-slate-300">Quantity</th>
                                <th class="px-6 py-4 text-right text-sm font-semibold text-slate-300">Price</th>
                                <th class="px-6 py-4 text-right text-sm font-semibold text-slate-300">P&L</th>
                            </tr>
                        </thead>
                        <tbody id="tradesBody" class="divide-y divide-slate-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 text-slate-400">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-lg">No trades loaded yet</p>
                <p class="text-sm mt-2">Upload a CSV file from ThinkorSwim to get started</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let allTrades = [];
        const STORAGE_KEY = 'trades-data';

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        function calculateStats(trades) {
            const totalTrades = trades.length;
            const profitableTrades = trades.filter(t => t.pnl > 0).length;
            const losingTrades = trades.filter(t => t.pnl < 0).length;
            const totalPnL = trades.reduce((sum, t) => sum + t.pnl, 0);
            const winRate = totalTrades > 0 ? (profitableTrades / totalTrades * 100).toFixed(1) : 0;
            const avgWin = profitableTrades > 0 ? trades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0) / profitableTrades : 0;
            const avgLoss = losingTrades > 0 ? trades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0) / losingTrades : 0;

            return { totalTrades, profitableTrades, losingTrades, totalPnL, winRate, avgWin, avgLoss };
        }

        function updateStats(stats) {
            document.getElementById('totalPnl').textContent = formatCurrency(stats.totalPnL);
            document.getElementById('totalPnl').className = `text-3xl font-bold ${stats.totalPnL >= 0 ? 'text-white' : 'text-red-200'}`;
            document.getElementById('winRate').textContent = stats.winRate + '%';
            document.getElementById('winLoss').textContent = `${stats.profitableTrades}W / ${stats.losingTrades}L`;
            document.getElementById('avgWin').textContent = formatCurrency(stats.avgWin);
            document.getElementById('avgLoss').textContent = formatCurrency(stats.avgLoss);
            document.getElementById('stats').classList.remove('hidden');
        }

        async function saveTrades(trades) {
            try {
                await window.storage.set(STORAGE_KEY, JSON.stringify(trades));
                document.getElementById('savedIndicator').classList.remove('hidden');
                document.getElementById('clearData').classList.remove('hidden');
                console.log('Trades saved successfully!');
            } catch (error) {
                console.error('Error saving trades:', error);
                alert('Failed to save trades online. Your data is still available in this session.');
            }
        }

        async function loadTrades() {
            try {
                const result = await window.storage.get(STORAGE_KEY);
                if (result && result.value) {
                    const trades = JSON.parse(result.value);
                    if (trades.length > 0) {
                        allTrades = trades;
                        const stats = calculateStats(allTrades);
                        updateStats(stats);
                        renderTrades(allTrades);
                        document.getElementById('savedIndicator').classList.remove('hidden');
                        document.getElementById('clearData').classList.remove('hidden');
                        console.log(`Loaded ${trades.length} trades from storage`);
                    }
                }
            } catch (error) {
                console.log('No saved trades found or error loading:', error);
            }
        }

        async function clearAllData() {
            if (confirm('Are you sure you want to delete all saved trades? This cannot be undone.')) {
                try {
                    await window.storage.delete(STORAGE_KEY);
                    allTrades = [];
                    document.getElementById('tradesBody').innerHTML = '';
                    document.getElementById('stats').classList.add('hidden');
                    document.getElementById('tradesTable').classList.add('hidden');
                    document.getElementById('searchBox').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('savedIndicator').classList.add('hidden');
                    document.getElementById('clearData').classList.add('hidden');
                    alert('All data cleared successfully!');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('Failed to clear data.');
                }
            }
        }

        function renderTrades(trades) {
            const tbody = document.getElementById('tradesBody');
            tbody.innerHTML = '';

            trades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700/30 transition-colors';
                
                const isBuy = trade.side?.toUpperCase().includes('BUY');
                const sideClass = isBuy ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400';
                const pnlClass = trade.pnl >= 0 ? 'text-green-400' : 'text-red-400';

                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-slate-300">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            ${formatDate(trade.date)}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-white font-semibold">${trade.symbol}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-400">${trade.type}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex px-2 py-1 rounded text-xs font-semibold ${sideClass}">
                            ${trade.side}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-slate-300">${trade.quantity}</td>
                    <td class="px-6 py-4 text-right text-sm text-slate-300">${formatCurrency(trade.price)}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-semibold ${pnlClass}">
                            ${formatCurrency(trade.pnl)}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('tradesTable').classList.remove('hidden');
            document.getElementById('searchBox').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function handleSearch(searchTerm) {
            if (!searchTerm) {
                renderTrades(allTrades);
            } else {
                const filtered = allTrades.filter(trade => 
                    trade.symbol?.toLowerCase().includes(searchTerm.toLowerCase())
                );
                renderTrades(filtered);
            }
        }

        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const appendMode = document.getElementById('appendMode').checked;

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    console.log('CSV parsed. Total rows:', results.data.length);
                    console.log('Found columns:', Object.keys(results.data[0] || {}));
                    console.log('First 3 rows:', results.data.slice(0, 3));
                    
                    // Filter out header rows and summary rows
                    const dataRows = results.data.filter(row => {
                        const firstCol = Object.values(row)[0];
                        // Skip if it's a header, summary, or empty row
                        if (!firstCol || typeof firstCol === 'string') {
                            const str = firstCol?.toLowerCase() || '';
                            if (str.includes('account statement') || 
                                str.includes('cash balance') || 
                                str.includes('date,time') ||
                                str === '') {
                                return false;
                            }
                        }
                        return true;
                    });
                    
                    console.log('Data rows after filtering:', dataRows.length);
                    console.log('First data row:', dataRows[0]);
                    console.log('First data row DESCRIPTION field:', dataRows[0]?.DESCRIPTION);
                    console.log('All column names in first data row:', Object.keys(dataRows[0] || {}));
                    
                    const newTrades = dataRows.map((row, index) => {
                        // Extract symbol from DESCRIPTION field
                        // Format: "BOT +2 MSFT @518.45" or "SOLD -1 FIG @69.47"
                        const description = row['DESCRIPTION'] || '';
                        const symbolMatch = description.match(/(?:BOT|SOLD)\s+[+-]?\d+\s+([A-Z]+)/);
                        const symbol = symbolMatch ? symbolMatch[1] : '';
                        
                        // Determine side (BUY/SELL)
                        const side = description.includes('BOT') ? 'BUY' : 
                                    description.includes('SOLD') ? 'SELL' : '';
                        
                        // Extract quantity
                        const qtyMatch = description.match(/[+-]?(\d+)\s+[A-Z]+/);
                        const quantity = qtyMatch ? Math.abs(parseInt(qtyMatch[1])) : 0;
                        
                        // Extract price
                        const priceMatch = description.match(/@([\d,.]+)/);
                        const price = priceMatch ? parseFloat(priceMatch[1].replace(',', '')) : 0;
                        
                        // Get P&L from AMOUNT column (negative values are losses)
                        const amount = row['AMOUNT'] || 0;
                        const pnl = typeof amount === 'string' ? 
                            parseFloat(amount.replace(/[,$"]/g, '')) : amount;
                        
                        // Get fees
                        const fees = row['Commissions & Fees'] || row['Misc Fees'] || 0;
                        const commission = typeof fees === 'string' ? 
                            parseFloat(fees.replace(/[,$"]/g, '')) : fees;
                        
                        // Combine DATE and TIME
                        const dateTime = `${row['DATE']} ${row['TIME']}`;
                        
                        const trade = {
                            id: appendMode ? allTrades.length + index : index,
                            date: dateTime,
                            symbol: symbol,
                            side: side,
                            quantity: quantity,
                            price: price,
                            pnl: pnl,
                            type: row['TYPE'] || 'TRD',
                            commission: commission,
                            netAmount: pnl
                        };
                        
                        if (index < 3) {
                            console.log(`Trade ${index}:`, trade);
                            console.log(`  - Description: "${description}"`);
                            console.log(`  - Symbol match result:`, symbolMatch);
                            console.log(`  - Symbol: "${symbol}", Side: "${side}"`);
                        }
                        
                        return trade;
                    }).filter(trade => trade.symbol && trade.side);
                    
                    console.log('Valid trades found:', newTrades.length);

                    console.log(`Parsed ${results.data.length} rows, ${newTrades.length} valid trades`);
                                        
                    if (allTrades.length > 0) {
                        if (appendMode) {
                            allTrades = [...allTrades, ...newTrades];
                            alert(`Added ${newTrades.length} new trades! Total: ${allTrades.length}`);
                        } else {
                            allTrades = newTrades;
                            alert(`Loaded ${newTrades.length} trades`);
                        }
                        
                        const stats = calculateStats(allTrades);
                        updateStats(stats);
                        renderTrades(allTrades);
                        await saveTrades(allTrades);
                    } else {
                        alert('No valid trades found in CSV. Please check the file format.');
                    }
                    
                    // Reset file input so same file can be uploaded again
                    e.target.value = '';
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                    e.target.value = '';
                }
            });
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            handleSearch(e.target.value);
        });

        document.getElementById('clearData').addEventListener('click', clearAllData);

        // Load saved trades on page load
        loadTrades();

        console.log('Trade Logger loaded successfully!');
    </script>
</body>
</html>
